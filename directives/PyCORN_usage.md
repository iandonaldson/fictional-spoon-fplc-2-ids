# PyCORN Installation and Usage Guide

**Local reference for fictional-spoon-fplc-2-ids project**  
**Last Updated**: 2026-01-17

## Overview

PyCORN is a Python library for extracting data from UNICORN chromatography result files (.res and .zip formats) generated by ÄKTA systems. This document describes the installation and actual API usage based on our implementation experience.

## Official Resources

- **Repository**: https://github.com/ronald-jaepel/PyCORN
- **Official Usage Guide**: https://github.com/ronald-jaepel/PyCORN/blob/master/pycorn/docs/USAGE_pycorn_module.md
- **File Structure Docs**: https://github.com/ronald-jaepel/PyCORN/blob/master/pycorn/docs/RES_files_layout.txt

## Installation

### Method 1: From GitHub (Recommended for this project)

```bash
cd /tmp
git clone https://github.com/pyahmed/PyCORN.git
cd PyCORN
pip install -e .
```

**Installed Version**: 0.18

### Method 2: From PyPI

```bash
pip install pycorn
```

**Note**: The PyPI version may differ from the GitHub version in API details.

## Important API Differences

⚠️ **The installed version (0.18) has API differences from the official documentation.**

### Official Documentation Says:
```python
from pycorn import PcUni6  # Capital P, capital U

data = PcUni6("sample.zip")
data.load(print_log=False)
data.load_all_xml()
```

### Actual API (v0.18):
```python
from pycorn import pc_uni6  # Lowercase

data = pc_uni6("sample.zip")
data.load()  # No parameters accepted
data.xml_parse()  # Not load_all_xml()
```

## Usage for UNICORN 6+ Zip Files

### Basic Example

```python
from pycorn import pc_uni6

# Load the zip file
data = pc_uni6("path/to/sample.zip")
data.load()

# Parse XML metadata and events
data.xml_parse()

# Access data
print(data.keys())
# >>> ['Chrom.1_1_True', 'Chrom.1_2_True', ..., 'Fractions', 'Inject', ...]
```

### Data Structure

After loading, `data` is an OrderedDict containing:

1. **Chromatogram keys**: `Chrom.1_X_True` (binary curve files)
2. **Metadata keys**: `Chrom.1.Xml` (XML metadata)
3. **Event keys**: `Fractions`, `Inject`, `Logbook` (parsed from XML)

### Accessing Curve Data

Each chromatogram file (`Chrom.1_X_True`) is itself a dict containing:
- `'CoordinateData.Volumes'`: List of floats (x-axis, typically mL)
- `'CoordinateData.Amplitudes'`: List of floats (y-axis, sensor reading)

```python
# Example: Access UV curve data
x_values = data['Chrom.1_1_True']['CoordinateData.Volumes']
y_values = data['Chrom.1_1_True']['CoordinateData.Amplitudes']

# Plot or process
import matplotlib.pyplot as plt
plt.plot(x_values, y_values)
plt.xlabel('Volume (mL)')
plt.ylabel('UV (mAU)')
```

### Accessing XML Metadata

```python
# XML content is stored as bytes in the dict
xml_content = data['Chrom.1.Xml']

# Parse with ElementTree
import xml.etree.ElementTree as ET
tree = ET.fromstring(xml_content)

# Access attributes
print(tree.attrib)
# >>> {'FormatVersion': '8', 'UNICORNVersion': '7.1.0.378'}
```

### Accessing Event Data

Events (Fractions, Inject, Logbook) are parsed by `xml_parse()`:

```python
# Check if events exist
if 'Fractions' in data:
    fractions = data['Fractions']
    print(f"Run name: {fractions['run_name']}")
    print(f"Data type: {fractions['data_name']}")
    
    # Event data is list of (volume, description) tuples
    for volume, description in fractions['data']:
        print(f"  {volume:.2f} mL - {description}")
```

### Available Methods

- `load(show=False)`: Load all files from the zip bundle
- `xml_parse(show=False)`: Parse XML metadata and create event dicts
- `zip2dict(input_zip)`: Convert zip contents to dict (static method)
- `unpacker(inp)`: Unpack binary data (static method)
- `clean_up()`: Remove temporary data (⚠️ WARNING: removes `Result.xml`)

## Common Pitfalls

### 1. Case Sensitivity
```python
# ✗ Wrong
from pycorn import PcUni6  # ImportError

# ✓ Correct
from pycorn import pc_uni6
```

### 2. Load Method Parameters
```python
# ✗ Wrong
data.load(print_log=False)  # TypeError

# ✓ Correct
data.load()
```

### 3. XML Parsing Method Name
```python
# ✗ Wrong (from documentation)
data.load_all_xml()  # AttributeError

# ✓ Correct (actual API)
data.xml_parse()
```

### 4. Accessing Date Before clean_up()
```python
# The 'date' property reads from 'Result.xml'
# which is removed by xml_parse() or clean_up()

# ✓ Correct order
data = pc_uni6(zip_path)
data.load()

# Get date BEFORE parsing XML
try:
    file_date = data.date
except (KeyError, AttributeError):
    file_date = None

# Now safe to parse XML
data.xml_parse()
```

## File Types Supported

### UNICORN 6+ Zip Format
- Multiple files bundled in a zip archive
- Binary curve data: `Chrom.1_X_True` files
- XML metadata: `Chrom.1.Xml`, `Result.xml`, `Manifest.xml`
- Metadata files: `MethodData`, `SystemData`, `InstrumentConfigurationData`, etc.

### Typical Zip Contents
```
sample.zip
├── Chrom.1.Xml              # Main chromatogram metadata
├── Chrom.1_1_True           # UV curve data
├── Chrom.1_2_True           # Conductivity curve data
├── Chrom.1_3_True           # Pressure curve data
├── ...
├── Result.xml               # Run result metadata
├── Manifest.xml             # File manifest
├── MethodData               # Method parameters
├── SystemData               # System configuration
└── InstrumentConfigurationData
```

## Data Types Extracted

PyCORN successfully extracts:

- **UV traces**: Multiple wavelengths (280nm, 295nm, etc.)
- **Conductivity**: mS/cm and percentage
- **Pressure**: System, PreColumn, PostColumn, DeltaColumn, Sample
- **Flow rates**: System flow, Sample flow, Linear flows
- **pH**: pH readings over time
- **Temperature**: Column and system temperatures
- **Events**: Fractions, Injections, Logbook entries

## Example: Complete Extraction Script

```python
#!/usr/bin/env python
"""Extract data from AKTA UNICORN 6 zip file"""

from pycorn import pc_uni6
import json

# Load file
print("Loading file...")
data = pc_uni6("sample.zip")
data.load()

# Get date before it's removed
file_date = None
try:
    file_date = data.date
except (KeyError, AttributeError):
    pass

# Parse XML
print("Parsing XML...")
data.xml_parse()

# Extract chromatogram data
print(f"Found {len([k for k in data.keys() if 'True' in k])} curves")

result = {
    "metadata": {
        "file_date": file_date,
    },
    "curves": {},
    "events": {}
}

# Process curves
for key in data.keys():
    if key.endswith('_True'):
        if 'CoordinateData.Volumes' in data[key]:
            volumes = data[key]['CoordinateData.Volumes']
            amplitudes = data[key]['CoordinateData.Amplitudes']
            
            result['curves'][key] = {
                "x": volumes,
                "y": amplitudes,
                "points": len(volumes)
            }
            print(f"  Curve {key}: {len(volumes)} points")

# Process events
for key in ['Fractions', 'Inject', 'Logbook']:
    if key in data:
        result['events'][key] = {
            "data": data[key].get('data', []),
            "name": data[key].get('data_name', key)
        }
        print(f"  Event {key}: {len(data[key].get('data', []))} entries")

# Save
with open('extracted_data.json', 'w') as f:
    json.dump(result, f, indent=2)

print("✓ Extraction complete")
```

## Troubleshooting

### Issue: ImportError - cannot import name 'PcUni6'
**Solution**: Use lowercase `pc_uni6` instead

### Issue: TypeError - load() got an unexpected keyword argument
**Solution**: Call `load()` with no parameters

### Issue: AttributeError - 'pc_uni6' object has no attribute 'load_all_xml'
**Solution**: Use `xml_parse()` instead

### Issue: Missing date/metadata
**Solution**: Access `data.date` before calling `xml_parse()` or `clean_up()`

### Issue: Empty data after load()
**Solution**: Make sure to call both `load()` and `xml_parse()` - `load()` only loads the zip structure

## Version Notes

This guide is based on:
- **PyCORN version**: 0.18
- **Installed from**: https://github.com/pyahmed/PyCORN.git
- **Date**: January 2026
- **Python**: 3.x

If using a different version, the API may vary. Always verify with `dir(pc_uni6)` and test on sample files.

## See Also

- [a2i.md](a2i.md) - AKTA to IDS converter directive
- [extract_akta.py](../execution/extract_akta.py) - Working extraction script
- [test_pycorn.py](../execution/test_pycorn.py) - Basic PyCORN test
